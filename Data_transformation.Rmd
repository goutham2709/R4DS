---
title: "Data_transformation"
author: "Goutham"
date: "10/18/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(nycflights13)
```


## Little practice before the exercises...
```{r}
?flights

flights
View(flights)  # To view the entire dataset
dim(flights)

filter(flights, day == 1, month == 1) %>% View()

jan1 <- filter(flights, day == 1, month == 1)
jan1

(nov_dec <- filter(flights, month %in% c(11,12)))
(nov_dec <- filter(flights, month == 11 | month == 12)) # Another way of writing above

#Demorgans law:
# !(x | y) = !x & !y
#! (x & y ) = !x | !y



```


### 5.3.4 Filtering rows with filter()

1. Find all flights that

1a. Had an arrival delay of two or more hours
```{r}
filter(flights, arr_delay >= 120)
```

1b. Flew to Houston (IAH or HOU)
```{r}
filter(flights, dest %in% c("IAH", "HOU"))
```

1c. Were operated by United, American, or Delta
```{r}
filter(flights, carrier %in% c("UA", "AA","DL"))
```

1d. Departed in summer (July, August, and September)
```{r}
filter(flights, month %in% c(7:9))
```

1e. Arrived more than two hours late, but didn’t leave late
```{r}
filter(flights, arr_delay > 120 & dep_delay <= 0)
```

1f. Were delayed by at least an hour, but made up over 30 minutes in flight
```{r}
filter(flights, dep_delay >= 60 & dep_delay - arr_delay > 30)
```

1g. Departed between midnight and 6am (inclusive)
```{r}
filter(flights, dep_time <= 600 | dep_time >= 2400) %>% dim()

summary(flights$dep_time)
```


2. Another useful dplyr filtering helper is between(). What does it do? Can you use it to simplify the code needed to answer the previous challenges?
```{r}
?between

between(1:12, 7, 9)
```


3. How many flights have a missing dep_time? What other variables are missing? What might these rows represent?
```{r}
filter(flights, is.na(dep_time))
```

4. Why is NA ^ 0 not missing? Why is NA | TRUE not missing? Why is FALSE & NA not missing? Can you figure out the general rule? (NA * 0 is a tricky counterexample!)
```{r}
NA ^ 0
NA | TRUE
FALSE & NA
NA * 0
```
NA ^ 0 is 1 because any x ^ 0 = 1
Na | TRUE is TRUE. Missing vale is T or F and T or F | T is always T
FALSE & NA is NA because anything false with & operator is always a false.
NA * 0 is NA because....?


### 5.3.1 Arrange rows with arrange()

1. How could you use arrange() to sort all missing values to the start? (Hint: use is.na()).
```{r}
arrange(flights, desc(is.na(dep_time)))


(df <- tibble(x = c(5, 2, NA), y = c(1, NA, 4)))
arrange(df, desc(is.na(y)))

?arrange
```

2. Sort flights to find the most delayed flights. Find the flights that left earliest.
```{r}
# summary(flights$dep_delay)

arrange(flights, desc(dep_delay))
arrange(flights, dep_delay)
```

3. Sort flights to find the fastest flights.
```{r}
arrange(flights, distance %% air_time)
```

4. Which flights travelled the longest? Which travelled the shortest?
```{r}
arrange(flights, air_time)
arrange(flights, desc(air_time))
```


### 5.4.1 Select columns with select()

1. Brainstorm as many ways as possible to select dep_time, dep_delay, arr_time, and arr_delay from flights.
```{r}
names(flights)
select(flights, dep_time, dep_delay, arr_time, arr_delay)
select(flights, 4, 6, 7, 9)
select(flights, dep_time:arr_delay, - sched_dep_time, - sched_arr_time)
select(flights, starts_with("dep"), starts_with("arr"))
select(flights, contains("delay"), contains("time"), - carrier, -sched_dep_time, -sched_arr_time, -air_time, - time_hour)
```

2. What happens if you include the name of a variable multiple times in a select() call?
```{r}
select(flights, arr_time, arr_time, arr_time, dep_time, dep_time)
```
R only optputs the variable once. The duplicates are ignored.

3. What does the one_of() function do? Why might it be helpful in conjunction with this vector?
```{r}
vars <- c("year", "month", "day", "dep_delay", "arr_delay")
select(flights, one_of(vars))

?select
```
one_of function amtches the names in the character vector to the variables in the dataframe.

4. Does the result of running the following code surprise you? How do the select helpers deal with case by default? How can you change that default?
```{r}
select(flights, contains("TIME"))
select(flights, contains("TIME", ignore.case = FALSE))
```
See help for helper function. In the arguments of the helper function, the default is to ignore the case of the string. If the ignore.case is set to FALSE, the result looks more like what we would expect.


### 5.5.2. Adding new variables with mutate()

1. Currently dep_time and sched_dep_time are convenient to look at, but hard to compute with because they’re not really continuous numbers. Convert them to a more convenient representation of number of minutes since midnight.
```{r}
# ?flights

#Referenced code. Not my own
flights_times <- mutate(flights,
  dep_time_mins = (dep_time %/% 100 * 60 + dep_time %% 100) %% 1440,
  sched_dep_time_mins = (sched_dep_time %/% 100 * 60 +
    sched_dep_time %% 100) %% 1440)

select(flights_times, dep_time_mins, sched_dep_time)
```

2. Compare air_time with arr_time - dep_time. What do you expect to see? What do you see? What do you need to do to fix it?
```{r}
fl <- select(flights, air_time, dep_time, arr_time)
mutate(fl,
       dep_arr = arr_time - dep_time) %>% View()
```
Air time is less than the dep - arr times. This might be because arr - dep times doesnot take into account the amount of time aircraft spent in the queue or the delays on ground due to traffic.

3. Compare dep_time, sched_dep_time, and dep_delay. How would you expect those three numbers to be related?
```{r}
flights_deptime <-
  mutate(flights,
    dep_time_min = (dep_time %/% 100 * 60 + dep_time %% 100) %% 1440,
    sched_dep_time_min = (sched_dep_time %/% 100 * 60 +
      sched_dep_time %% 100) %% 1440,
    dep_delay_diff = dep_delay - dep_time_min + sched_dep_time_min
  )

```
dep delay would be the difference between the dep time and sched dep time. But the differnce is not 0 in this case.

4. Find the 10 most delayed flights using a ranking function. How do you want to handle ties? Carefully read the documentation for min_rank().
```{r}
?min_rank()

delayed <- mutate(flights,
       rank = min_rank(desc(dep_delay)))

select(delayed, rank, dep_delay, carrier, flight) %>% arrange(rank)

```
min_rank ranks the ascending order of the elements in the vector.

5. What does 1:3 + 1:10 return? Why?
```{r}
1:3 + 1:10
```
R recycling rules.

6. What trigonometric functions does R provide?
```{r}
?Trig
```
cos(x)
sin(x)
tan(x)

acos(x)
asin(x)
atan(x)
atan2(y, x)

cospi(x)
sinpi(x)
tanpi(x)

are provided by R in the documentation for trigonometric functions.

### 5.5.2. Adding new variables with mutate() - Redo

1. Currently dep_time and sched_dep_time are convenient to look at, but hard to compute with because they’re not really continuous numbers. Convert them to a more convenient representation of number of minutes since midnight.
```{r}
?flights

flights %>% View()

mutate(flights,
       dep_time = (dep_time %/% 100 * 60 + dep_time / 100) %/% 1440,
       sched_dep_time = (sched_dep_time %/% 100 * 60 + sched_dep_time %/% 100 * 60) %/% 1440)
```

### 5.6.7 Group variables with summarize()

1. Brainstorm at least 5 different ways to assess the typical delay characteristics of a group of flights. Consider the following scenarios:

1a. A flight is 15 minutes early 50% of the time, and 15 minutes late 50% of the time.
```{r}
flights %>% group_by(year, month) %>% summarise(delay = mean(dep_delay, na.rm = TRUE)) %>% View()

flights %>% group_by(flight, dest) %>% summarize(count = n(), dist = mean(distance, na.rm = TRUE), delay = mean(arr_delay, na.rm = TRUE)) %>% filter(count < 20, dest != "HNL")

flights %>% group_by(flight, carrier) %>% summarize(count = n(), arr_delay = median(arr_delay, na.rm = TRUE)) %>% filter(arr_delay < -15)
```

1b. A flight is always 10 minutes late.
```{r}
flights %>% group_by(flight, carrier) %>% filter(arr_delay == 10) %>% select(flight, carrier, arr_delay)
```

1c. A flight is 30 minutes early 50% of the time, and 30 minutes late 50% of the time.
```{r}
flights %>% group_by(carrier) %>% summarize(count = n(), median = median(arr_delay, na.rm = TRUE)) %>% filter(median < -30)
```

1d. 99% of the time a flight is on time. 1% of the time it’s 2 hours late.
??

1f. Which is more important: arrival delay or departure delay?
Departure delay is more important as time is money and we want flights that are on time. 

2. Come up with another approach that will give you the same output as not_cancelled %>% count(dest) and not_cancelled %>% count(tailnum, wt = distance) (without using count()).
```{r}
not_cancelled <- flights %>% filter(!is.na(dep_delay), !is.na(arr_delay))
not_cancelled %>% group_by(dest) %>% summarize(number = n())

not_cancelled %>% count(tailnum, wt = distance)
not_cancelled %>% group_by(tailnum) %>% summarize(distance_summed = sum(distance))
```

3.Our definition of cancelled flights (is.na(dep_delay) | is.na(arr_delay) ) is slightly suboptimal. Why? Which is the most important column?
dep_delay is more important as it costs money for the delayed time. 

4. Look at the number of cancelled flights per day. Is there a pattern? Is the proportion of cancelled flights related to the average delay?
```{r}
flights %>% 
  mutate(cancelled = is.na(dep_delay) | is.na(arr_delay)) %>% 
  group_by(day) %>% 
  summarize(cancelled = sum(cancelled),
            num_of_flights = n())
```

5. Which carrier has the worst delays? Challenge: can you disentangle the effects of bad airports vs. bad carriers? Why/why not? (Hint: think about flights %>% group_by(carrier, dest) %>% summarise(n()))
```{r}
flights %>%
  group_by(carrier) %>% 
  summarize(del = mean(dep_delay + arr_delay, na.rm = TRUE)) %>% 
  arrange(desc(del))
```
Disentangle?

5. What does the sort argument to count() do. When might you use it?
```{r}
?count
```
If TRUE, sort argument will sort output in descending order of n.


### 5.7.1 Grouped mutates and filters

















